<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ER-Stock Management</title>
    <base href="/" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script type="text/javascript" src="C:\Users\eetur\source\repos\ER-Stock Management\CommonFunctions.js"></script>
    <link href="C:\Users\eetur\source\repos\ER-Stock Management\Default.css" rel="stylesheet" />
    <link href="C:\Users\eetur\source\repos\ER-Stock Management\Darkmode.css" rel="stylesheet" />
</head>
<body>
    <h3 id="Title"></h3>
    <div class="col-auto py-3">
        <button type="button" class="btn-secondary" onclick="Redirect('BrowseStore.html')">Main page</button>
    </div>
    <div class="col-6 text-end d-inline-block">
        <img class="flags p-2" src="finnish.png" alt="FI" />
        <img class="flags p-2" src="english.png" alt="EN" />
        <img class="p-2" id="pagecolor" src="darkmode.png" alt="Light/Dark" />
    </div>

    <h3 id="Message"></h3>

    <div class="container">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">Products Name</th>
                    <th scope="col">Amount in stock</th>
                    <th scope="col">Categories</th>
                    <th scope="col">Modified on (UTC)</th>
                </tr>
            </thead>
            <tbody id="table">
                <tr>
                    <td>
                        <input type="button" name="NewProduct" value="New" class="btn btn-primary" onclick="NewProduct()" />
                        <input type="text" id="NewName" placeholder="Name">
                    </td>
                    <td><input type="text" id="NewAmount" placeholder="Amount"></td>
                    <td id="NewCategories"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        let storeAndData;
        let categories = [];
        let counter = 0;

        document.addEventListener('DOMContentLoaded', () => RenderPage(), false);

        async function RenderPage() {
            storeAndData = JSON.parse(localStorage.getItem("StoreAndProducts"));
            console.log(storeAndData);
            await GetAllCategories();
            categories = JSON.parse(localStorage.getItem("Categories"));
            console.log(categories);

            await NewCategoryLabels();

            if (storeAndData['products']) {
                storeAndData['products'].forEach((element, index) => CreateProductInfo(element, index));
            }
        }

        function CreateProductInfo(element, index) {
            const tBody = document.getElementById('table');
            const row = document.createElement('tr');
            const rowId = 'product' + index;
            row.id = rowId;
            tBody.appendChild(row);

            const modifyCell = document.createElement('td');
            const modifyCellId = 'ModifyCell' + index;
            modifyCell.id = modifyCellId;
            row.appendChild(modifyCell);

            const modifyButton = document.createElement('button');
            modifyButton.type = 'button';
            modifyButton.className = 'btn-primary';

            const storeId = localStorage.getItem("StoreId");

            modifyButton.onclick = () => { ModifyProduct(storeId, element, index) };
            modifyCell.appendChild(modifyButton);

            const productName = document.createElement('input');
            productName.type = 'text';
            productName.id = "ProductName" + index;
            productName.value = element['name'];
            modifyCell.appendChild(productName);

            const amountCell = document.createElement('td');
            row.appendChild(amountCell);

            const amount = document.createElement('input');
            amount.type = 'text';
            amount.id = "Amount" + index;
            amount.value = element['inStock'];
            amountCell.appendChild(amount);

            const categoryCell = document.createElement('td');
            categoryCell.id = 'categoryCell' + index;
            row.appendChild(categoryCell);

                for (const entry of categories) {
                    var catLabel = document.createElement("label");
                    catLabel.setAttribute("for", counter);
                    catLabel.textContent = entry['name'];
                    categoryCell.appendChild(catLabel);

                    var catCheckbox = document.createElement("input");
                    catCheckbox.type = "checkbox";
                    catCheckbox.className = "form-check-input";
                    catCheckbox.id = counter;
                    catCheckbox.value = entry['id'];

                    const categoryIds = Array.from(element['categoryIds']);
                    console.log(categoryIds);

                    if (categoryIds.length != 0) {
                        for (const id of categoryIds) {
                            if (id == entry['id']) {
                                catCheckbox.checked = true;
                            }
                        }
                    }

                    categoryCell.appendChild(catCheckbox);
                    counter++;
                }

            const timestampCell = document.createElement('td');

            let currentDate = new Date(element['timestamp']).toLocaleDateString("en-GB").toString()
            let currentTime = new Date(element['timestamp']).toLocaleTimeString("en-GB").toString();
            let displayed = currentDate + " " + currentTime;

            timestampCell.textContent = displayed;
            row.appendChild(timestampCell);
        }

        async function NewCategoryLabels() {
            let newCatCounter = 0;
            const newCategories = document.getElementById("NewCategories");
            for (const entry of categories) {
                var catLabel = document.createElement("label");
                const catId = 'NewCat' + newCatCounter;
                catLabel.setAttribute("for", catId);
                catLabel.textContent = entry['name'];
                newCategories.appendChild(catLabel);

                var catCheckbox = document.createElement("input");
                catCheckbox.type = "checkbox";
                catCheckbox.className = "form-check-input";
                catCheckbox.id = "NewCat" + newCatCounter;
                console.log(entry['id']);
                catCheckbox.value = entry['id'];

                newCategories.appendChild(catCheckbox);
                newCatCounter++;
            }
        }

        async function GetAllCategories() {
            try {
                const promise = await fetch('https://localhost:7233/GetAllCategories');

                if (!promise.ok) {
                    document.getElementById('Message').innerHTML = 'Failed to get categories. Please try again later.';
                }

                const data = await promise.json();
                console.log(data);
                localStorage.setItem('Categories', JSON.stringify(data));
            }

            catch (error) {
                console.error(error);
            }
        }

        async function NewProduct() {
            const storeId = localStorage.getItem("StoreId");
            const name = document.getElementById("NewName").value;
            console.log(name);
            const amount = document.getElementById("NewAmount").value;
            console.log(amount);

            let categoryIds = [];

            var divContent = document.getElementById('NewCategories').children;
            console.log(divContent)
            for (const entry of divContent) {

                if (entry.className == 'form-check-input') {
                    console.log(entry.className);
                    if (entry.checked) {
                        console.log(entry.value)
                        categoryIds.push(entry.value);
                    }
                }
            }
            console.log(categoryIds);
            var jsonObject = {
                storeid: storeId,
                productid: '',
                name: name,
                categoryids: categoryIds,
                instock: amount
            }

            const json = JSON.stringify(jsonObject);

            await fetch('https://localhost:7233/NewProduct', {
                method: 'POST',
                headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                body: json
            }).then(response => {
                if (response.ok) {
                    //location.reload();
                    console.log("LÄPI MENI");
                    GetUpdatedStoreInfo();
                }
                else {
                    document.getElementById('Message').innerHTML = response.status + ': Failed to add new product';
                }
            });
        }

        async function GetUpdatedStoreInfo() {
            try {
                const storeId = localStorage.getItem("StoreId");
                const url = 'https://localhost:7233/GetStoreDataWithId?id=' + storeId;
                const promise = await fetch(url);

                if (!promise.ok) {
                    document.getElementById('Message').innerHTML = 'Failed to get Store. Please try again later.';
                }

                const data = await promise.json();
                console.log(data);
                localStorage.setItem('StoreAndProducts', JSON.stringify(data));
                console.log("STORE DATA UPDATED")
                location.reload();
            }

            catch (error) {
                console.error(error);
            }
        }

        function ModifyProduct(storeId, element, index) {
            let categoryIds = [];
            console.log("Mitä kuuluu kukkuluuruu", storeId, element, index);

            var divContent = document.getElementById('categoryCell' + index).children;
            console.log(divContent);
            for (const entry of divContent) {
                if (entry.className == 'form-check-input') {
                    console.log(entry.className);
                    if (entry.checked) {
                        console.log(entry.value)
                        categoryIds.push(entry.value);
                    }
                }
            }

            const newName = document.getElementById('ProductName' + index).value;
            console.log(newName);
            const newAmount = document.getElementById('Amount' + index).value;
            console.log(newAmount);

            var jsonObject = {
                storeid: storeId,
                productid: element['id'],
                name: newName,
                categoryids: categoryIds,
                instock: newAmount
            }

            const json = JSON.stringify(jsonObject);

            //let queryString = new URLSearchParams(jsonObject).toString();
            const url = "https://localhost:7233/ModifyProduct";

            console.log(jsonObject);
            fetch(url, {
                method: 'PUT',
                headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                body: json
            }).then(response => {
                if (response.ok) {
                    console.log("LÄPI MENI");
                    GetUpdatedStoreInfo();
                }
                else {
                    document.getElementById('Message').innerHTML = response.status + ': Failed to modify product.';
                }
            });
        }
    </script>
</body>
</html>