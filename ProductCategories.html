<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="C:\Users\eetur\source\repos\ER-Stock Management\Default.css" rel="stylesheet" />
    <link href="C:\Users\eetur\source\repos\ER-Stock Management\Darkmode.css" rel="stylesheet" />
    <script type="text/javascript" src="C:\Users\eetur\source\repos\ER-Stock Management\CommonFunctions.js"></script>
    <title>ER-Stock Management Product Categories</title>
</head>
<body>
    <div class="container">
        <div class="row p-2">
            <div class="col-sm text-nowrap">
                <div class="text-left" id="company">ER-Stock Management</div>
            </div>
            <div class="col-md d-flex d-inline align-self-center justify-content-md-end text-nowrap">
                <div class="d-flex d-inline">
                    <img class="icons" src="C:\Users\eetur\source\repos\ER-Stock Management\fi.png" alt="FI" />
                    <div>&emsp;</div>
                    <img class="icons" src="C:\Users\eetur\source\repos\ER-Stock Management\gb.png" alt="EN" />
                    <div>&emsp;</div>
                    <img class="icons" src="C:\Users\eetur\source\repos\ER-Stock Management\dark.png" alt="Light/Dark" />
                </div>
            </div>
        </div>

        <div class="col-auto py-3">
            <button type="button" class="btn btn-secondary" onclick="Redirect('Index.html')">Main page</button>
        </div>

        <h4>Product categories</h4>
        <h4>Add, modify or delete product categories here</h4>
        <h4 id="Message"></h4>

        <table id="categoryInfo" class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">Category Name</th>
                    <!--<th scope="col">Modify category</th>-->
                </tr>
            </thead>
            <tbody id="categories">
                <tr>
                    <td>
                        <button type="submit" onclick="NewCategory()" class="btn btn-primary">Add New</button>
                        <input type="text" id="NewCategoryName" placeholder="New Category">
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <script>
        const form = document.querySelector('#categoryInfo');

        document.addEventListener('DOMContentLoaded', function () {
            GetAllCategories();
            form.addEventListener('submit', (event) => {
                event.preventDefault();
            });
        });

        async function GetAllCategories() {
            const promise = fetch('https://localhost:7233/GetAllCategories')
                .then(data => {
                    if (!data.ok) {
                        document.getElementById('Message').innerHTML = 'Failed to get categories. Please try again later.';
                        throw new Error("Promise chain cancelled");
                    }
                    return data.json();
                })
                .then(data => {
                    console.log(data)
                    if (!data) {
                        document.getElementById('Message').innerHTML = 'There are no categories. Please add new one to continue';
                        throw new Error("Promise chain cancelled");
                    }
                    else {
                        data.forEach((element, index) => CreateCategoryCell(element, index))
                    }

                })
                .catch((error) => {
                    console.error(error)
                }); 
        }

        function CreateCategoryCell(element, index) {
            console.log(element, index);
            const row = document.getElementById('categories');
            const cell = document.createElement('tr');
            const cellId = 'category' + index;
            cell.id = cellId;
            row.appendChild(cell);

            const createdCell = document.getElementById(cellId);

            const inputId = cellId + "Input";
            var input = document.createElement("input");
            input.type = "text";
            input.value = element["name"];
            input.placeholder = element["name"];
            input.id = inputId;
            createdCell.appendChild(input);

            var submit = document.createElement("input");
            submit.type = "submit";
            submit.className = "btn btn-primary";
            submit.value = "Modify";
            console.log("IdNumero:", inputId);
            submit.onclick = () => { Modify(element, inputId) }
            createdCell.appendChild(submit);

            const boxId = cellId + "Delete";

            var deleteLabel = document.createElement("label");
            deleteLabel.setAttribute("for", boxId);
            deleteLabel.textContent = "Delete category?"
            createdCell.appendChild(deleteLabel);

            var deleteCheckbox = document.createElement("input");
            deleteCheckbox.type = "checkbox";
            deleteCheckbox.className = "form-check-input";
            deleteCheckbox.id = boxId;
            deleteLabel.appendChild(deleteCheckbox);
            

            var deleteButton = document.createElement("input");
            deleteButton.type = "button";
            deleteButton.className = "btn btn-danger";
            deleteButton.value = "Delete";
            deleteButton.onclick = () => { Delete(element["id"], boxId) }
            createdCell.appendChild(deleteButton);
        }

        function NewCategory() {
            console.log("Lisääkkö nää uuden?");
            const newCategoryName = document.getElementById("NewCategoryName").value;

            const url = "https://localhost:7233/NewCategory?name=" + newCategoryName;

            fetch(url, {
                method: "POST",
                headers: { 'Content-Type': 'application/json' }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
                else {
                    document.getElementById("Message").innerHTML = response.status + ": Failed to add new category.";
                }
            });
                
        }

        function Modify(category, inputId) {
            console.log("Mitä kuuluu kukkuluuruu", category);
            const newName = document.getElementById(inputId).value;
            console.log(newName);
            category["name"] = newName;
            const json = JSON.stringify(category);
            console.log(json);
            fetch("https://localhost:7233/ModifyCategory", {
                method: 'PUT',
                headers: { /*'Accept': 'application/json',*/ 'Content-Type': 'application/json' },
                body: json
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
                else {
                    document.getElementById('Message').innerHTML = response.status + ': Failed to modify category.';
                }
            });
        }

        function Delete(categoryId, boxId) {
            console.log("Mitä kuuluu kukkuluuruu, lähekkö nää pois?", categoryId, boxId);
            if (!document.getElementById(boxId).checked) {
                return;
            }

            const url = "https://localhost:7233/DeleteCategory?id=" + categoryId;

            fetch(url, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: categoryId
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
                else {
                    document.getElementById('Message').innerHTML = response.status + ': Failed to delete category.';
                }
            });
        }

    </script>
</body>
</html>