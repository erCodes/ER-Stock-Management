<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="Default.css" rel="stylesheet" />
    <script type="text/javascript" src="CommonFunctions.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <title>ER-Stock Management Browse Store</title>
</head>
<body>
    <div class="container">
        <div class="row p-2">
            <div class="col-sm text-nowrap">
                <div class="text-left" id="company">ER-Stock Management</div>
            </div>
            <div class="col-md d-flex d-inline align-self-center justify-content-md-end text-nowrap">
                <div class="d-flex d-inline">
                    <img class="icons" src="fi.png" onclick="ChangeLanguage('fi')" alt="FI" />
                    <div>&emsp;</div>
                    <img class="icons" src="gb.png" onclick="ChangeLanguage('en')" alt="EN" />
                    <div>&emsp;</div>
                    <img class="icons" src="dark.png" onclick="SetDarkmode()" alt="Light/Dark" />
                </div>
            </div>
        </div>

        <div class="col-auto py-3">
            <button type="button" id="mainPage" class="btn btn-secondary" onclick="Redirect('Index.html')"></button>
        </div>

        <h4 id="Message"></h4>

        <button type="button" id="modifyStoreInfo" class="btn btn-secondary" onclick="Redirect('ModifyStoreInfo.html')"></button>
        <button type="button" id="deleteStore" class="btn btn-danger" onclick="ShowWarning()"></button>

        <div class="row py-2">
            <div class="col" id="WarningText"></div>
            <div class="col" id="DeleteCol">
            </div>
        </div>

        <h3 id="Name"></h3>

        <div class="row py-2">
            <div id="cityLabel" class="col"></div>
            <div class="col" id="City"></div>
        </div>
        <div class="row py-2">
            <div id="addressLabel" class="col"></div>
            <div class="col" id="Address"></div>
        </div>
        <div class="row py-2">
            <div id="supervisorLabel" class="col"></div>
            <div class="col" id="Supervisor"></div>
        </div>
        <div class="row py-2">
            <div id="phoneLabel" class="col"></div>
            <div class="col" id="Phone"></div>
        </div>
        <div class="row py-2">
            <div id="emailLabel" class="col"></div>
            <div class="col" id="Email"></div>
        </div>

        <div class="row">
            <div>
                <button type="button" id="viewProductsButton" class="btn btn-primary" onclick="Redirect('ViewProducts.html')"></button>
            </div>
        </div>

        <canvas id="myChart1"></canvas>

    </div>

    <script>
        let warningShown = false;
        let storeId = "";
        let lang = "";

        document.addEventListener('DOMContentLoaded', () => RenderPage(), false);

        async function RenderPage() {
            storeId = localStorage.getItem("StoreId");
            lang = localStorage.getItem("Lang")
            await CheckMode();

            document.getElementById("mainPage").innerHTML = Translation("MainPage", lang);
            document.getElementById("cityLabel").innerHTML = Translation("City", lang);
            document.getElementById("addressLabel").innerHTML = Translation("Address", lang);
            document.getElementById("supervisorLabel").innerHTML = Translation("Supervisor", lang);
            document.getElementById("phoneLabel").innerHTML = Translation("Phone", lang);
            document.getElementById("emailLabel").innerHTML = Translation("Email", lang);
            document.getElementById("modifyStoreInfo").innerHTML = Translation("ModifyStoreInfo", lang);
            document.getElementById("deleteStore").innerHTML = Translation("DeleteStore", lang);
            document.getElementById("viewProductsButton").innerHTML = Translation("ViewProductsButton", lang);

            await GetStoreInfo(storeId);
            let storeData = JSON.parse(localStorage.getItem("StoreAndProducts"));
            let productNames = [];
            let productCount = [];

            let products = Array.from(storeData['products']);

            for (const product of products) {
                productNames.push(product["name"]);
                productCount.push(product["inStock"]);
            }

            ProductChart(productNames, productCount, Translation("ProductChart", lang));
        }

        async function GetStoreInfo(storeId) {
            const url = "https://localhost:7233/GetStoreDataWithId?id=" + storeId;

            await fetch(url)
                .then(data => {
                    if (!data.ok) {
                        document.getElementById('Message').innerHTML = Translation("ErrorMessage", lang);
                        throw new Error("Promise chain cancelled");
                    }
                    return data.json();
                })
                .then(data => {
                    if (!data) {
                        document.getElementById('Message').innerHTML = Translation("ErrorMessage", lang);
                        throw new Error("Promise chain cancelled");
                    }
                    else {
                        document.getElementById('Name').innerHTML = data["name"];
                        document.getElementById('City').innerHTML = data["city"];
                        document.getElementById('Address').innerHTML = data["address"];
                        document.getElementById('Supervisor').innerHTML = data["supervisor"];
                        document.getElementById('Phone').innerHTML = data["phone"];
                        document.getElementById('Email').innerHTML = data["email"];
                        localStorage.setItem("StoreAndProducts", JSON.stringify(data));
                    }
                })
                .catch((error) => {
                    console.error(error)
                }); 
        }

        function ShowWarning() {
            if (!warningShown) {
                document.getElementById("WarningText").innerHTML = Translation("DeleteWarningText", lang);

                var delCol = document.getElementById("DeleteCol");
                var delButton = document.createElement('input');
                delButton.type = "button";
                delButton.className = "btn btn-danger";
                delButton.value = Translation("IAmSure", lang);
                delButton.onclick = () => { DeleteStore(storeId) };
                delCol.appendChild(delButton);

                warningShown = true;
            }
        }

        function DeleteStore(storeId) {
            const url = "https://localhost:7233/DeleteStore?id=" + storeId;

            fetch(url, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: storeId
            }).then(response => {
                if (response.ok) {
                    Redirect("Index.html");
                }
                else {
                    document.getElementById('Message').innerHTML = Translation("ErrorMessage", lang);
                }
            });
        }

        let chart1 = null;
        function ProductChart(productNames, productCount, title) {
            // Colors for the chart.
            var colors = [];
            while (colors.length < productNames.length) {
                do {
                    var color = Math.floor((Math.random() * 1000000) + 1);
                } while (colors.indexOf(color) >= 0);
                colors.push("#" + ("000000" + color.toString(16)).slice(-6));
            }

            // Chart
            let myChart1 = document.getElementById('myChart1').getContext('2d');

            Chart.defaults.global.defaultFontFamily = 'Arial';
            Chart.defaults.global.defaultFontSize = 12;
            Chart.defaults.global.defaultFontColor = 'green';

            chart1 = new Chart(myChart1, {
                type: 'pie',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Tiedot',
                        data: productCount,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: 'white',
                        hoverBorderWidth: 3,
                        hoverBorderColor: 'black'
                    }]
                },
                options: {
                    responsive: true,
                    title: {
                        display: true,
                        text: title,
                        fontSize: 25
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            fontColor: '#808080'
                        }
                    },
                    layout: {
                        padding: {
                            left: 0,
                            right: 0,
                            bottom: 0,
                            top: 0
                        }
                    },
                    tooltips: {
                        callbacks: {
                            label: function (tooltipItem, data) {
                                var allData = data.datasets[tooltipItem.datasetIndex].data;
                                var tooltipLabel = data.labels[tooltipItem.index];
                                var tooltipData = allData[tooltipItem.index];
                                var total = 0;
                                for (var i in allData) {
                                    total += allData[i];
                                }
                                var tooltipPercentage = Math.round((tooltipData / total) * 100);
                                return tooltipLabel + ': ' + tooltipData + ' (' + tooltipPercentage + '%)';
                            }
                        }
                    }
                }
            })
        }
    </script>
</body>
</html>